<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gartic.io Kullanıcı Listesi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Koyu Tema Varsayılanları */
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --card-bg: #0f3460;
            --text-color: #e0e0e0;
            --accent-color-blue: #007bff;
            --accent-color-red: #e74c3c;
            --border-color: #007bff;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --gradient-start: #1a1a2e;
            --gradient-end: #0f3460;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px var(--shadow-color);
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            color: var(--accent-color-blue);
            text-align: center;
            margin-bottom: 20px;
        }

        .language-selection {
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .language-selection h3 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            appearance: none; /* Varsayılan ok simgesini kaldır */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .form-select:focus {
            border-color: var(--accent-color-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
        }

        .form-select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.9a17.6%2017.6%200%200%200-24.9%200L146.2%20185.3%2030.3%2069.9a17.6%2017.6%200%200%200-24.9%2024.9l130.6%20130.6c6.8%206.8%2017.9%206.8%2024.7%200l130.6-130.6c6.8-6.8%206.8-17.9%200-24.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
        }

        .language-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .language-button {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, transform 0.2s, border-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-button:hover {
            background-color: var(--accent-color-blue);
            transform: translateY(-2px);
        }

        .language-button.active {
            background-color: var(--accent-color-blue);
            border-color: var(--accent-color-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
        }

        .flag {
            font-size: 1.2rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center; /* ORTALAMA */
            align-items: center;
        }

        .controls input[type="text"] {
            flex-grow: 1;
            padding: 8px 12px; /* DAHA DA KÜÇÜLTÜLDÜ */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            max-width: 150px; /* DAHA DA KÜÇÜLTÜLDÜ */
            height: 30px; /* SABİT YÜKSEKLİK */
            box-sizing: border-box; /* Padding ve border yüksekliğe dahil */
        }

        .controls input[type="number"] { /* Proxy input için eklendi */
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            max-width: 100px; /* Daha küçük */
            height: 30px;
            box-sizing: border-box;
            text-align: center;
        }

        .controls input[type="text"]::placeholder {
            color: #ccc;
        }

        .controls button {
            padding: 5px 8px; /* DAHA DA KÜÇÜLTÜLDÜ */
            border-radius: 8px;
            border: none;
            background-color: var(--accent-color-blue);
            color: white;
            font-size: 0.75rem; /* DAHA DA KÜÇÜLTÜLDÜ */
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 80px; /* DAHA DA KÜÇÜLTÜLDÜ */
            height: 30px; /* SABİT YÜKSEKLİK */
            box-sizing: border-box; /* Padding ve border yüksekliğe dahil */
        }

        .controls button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .controls button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex; /* YAN YANA HİZALAMA */
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center; /* EK: Ortalamak için */
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-color-blue);
            cursor: pointer;
        }

        .stats {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        #loadingIndicator {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--accent-color-blue);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* KÜÇÜLTÜLDÜ */
            gap: 15px; /* KÜÇÜLTÜLDÜ */
            justify-content: center;
        }

        .user {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 12px; /* KÜÇÜLTÜLDÜ */
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* KÜÇÜLTÜLDÜ */
            position: relative;
            transition: transform 0.2s;
            text-align: center;
        }

        .user:hover {
            transform: translateY(-5px);
        }

        .user img {
            width: 60px; /* KÜÇÜLTÜLDÜ */
            height: 60px; /* KÜÇÜLTÜLDÜ */
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color-blue);
            flex-shrink: 0;
            cursor: pointer;
        }

        .user.nofoto img {
            border: 3px solid var(--accent-color-red);
        }

        .user.discord img {
            border: 3px solid #7289da; /* Discord Blue */
        }

        .user-details {
            flex-grow: 1;
        }

        .user-details b {
            font-size: 0.95rem; /* KÜÇÜLTÜLDÜ */
            color: var(--accent-color-blue);
            word-break: break-word;
        }

        .user-details i {
            display: block;
            margin-top: 2px; /* KÜÇÜLTÜLDÜ */
            font-style: normal;
            color: #bbb;
            font-size: 0.85rem; /* KÜÇÜLTÜLDÜ */
        }

        .room-link {
            display: inline-block;
            margin-top: 2px; /* KÜÇÜLTÜLDÜ */
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.75rem; /* KÜÇÜLTÜLDÜ */
            background-color: rgba(0, 123, 255, 0.2);
            padding: 2px 5px; /* KÜÇÜLTÜLDÜ */
            border-radius: 44px;
            transition: background-color 0.3s;
            word-break: break-all;
        }

        .room-link:hover {
            background-color: var(--accent-color-blue);
        }

        .action-buttons {
            margin-top: 6px; /* KÜÇÜLTÜLDÜ */
            display: flex;
            flex-wrap: wrap;
            gap: 5px; /* KÜÇÜLTÜLDÜ */
            justify-content: center;
        }

        .action-buttons button {
            padding: 3px 7px; /* KÜÇÜLTÜLDÜ */
            border-radius: 4px;
            border: none;
            background-color: #555;
            color: white;
            cursor: pointer;
            font-size: 0.7rem; /* KÜÇÜLTÜLDÜ */
            transition: background-color 0.3s;
        }

        .action-buttons button:hover {
            background-color: #777;
        }

        .discord-profile-btn {
            background-color: #7289da !important; /* Discord Blue */
        }

        .discord-profile-btn:hover {
            background-color: #677bc4 !important;
        }

        .favorite-btn {
            position: absolute;
            top: 6px; /* KÜÇÜLTÜLDÜ */
            right: 6px; /* KÜÇÜLTÜLDÜ */
            background: none !important;
            border: none !important;
            color: #ccc;
            font-size: 1.1rem; /* KÜÇÜLTÜLDÜ */
            cursor: pointer;
            transition: color 0.2s;
            padding: 2px; /* KÜÇÜLTÜLDÜ */
        }

        .favorite-btn:hover {
            color: #ffc107 !important;
        }

        .favorite-btn.favorited {
            color: #ffc107;
        }

        /* Profil Modal */
        .profile-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .profile-modal-content {
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .profile-modal-content h2 {
            color: var(--accent-color-blue);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .profile-modal-content img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-color-blue);
            margin-bottom: 20px;
        }

        .profile-modal-content p {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .profile-modal-content .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-modal-content .modal-buttons button,
        .profile-modal-content .modal-buttons a {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .profile-modal-content .modal-buttons .close-btn {
            background-color: var(--accent-color-red);
            color: white;
        }

        .profile-modal-content .modal-buttons .close-btn:hover {
            background-color: #c0392b;
        }

        .profile-modal-content .modal-buttons .view-photo-link,
        .profile-modal-content .modal-buttons .discord-profile-btn {
            background-color: var(--accent-color-blue);
            color: white;
        }

        .profile-modal-content .modal-buttons .view-photo-link:hover,
        .profile-modal-content .modal-buttons .discord-profile-btn:hover {
            background-color: #0056b3;
        }

        .profile-modal-content .modal-buttons .discord-profile-btn {
            background-color: #7289da;
        }

        .profile-modal-content .modal-buttons .discord-profile-btn:hover {
            background-color: #677bc4;
        }

        /* Go to Top Button */
        #goToTopBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed/sticky position */
            bottom: 30px; /* Place the button at the bottom of the page */
            right: 30px; /* Place the button 30px from the right */
            z-index: 99; /* Make sure it does not overlap */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: var(--accent-color-blue); /* Set a background color */
            color: white; /* Text color */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 10px; /* Rounded corners */
            font-size: 18px; /* Increase font size */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s, transform 0.2s, opacity 0.3s;
            opacity: 0.8;
        }

        #goToTopBtn:hover {
            background-color: #0056b3; /* Darker background on hover */
            transform: translateY(-3px);
            opacity: 1;
        }

        .footer {
            margin-top: 40px;
            font-size: 0.9rem;
            color: #888;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
            }

            .controls input[type="text"],
            .controls button,
            .controls input[type="number"] { /* Proxy input için de düzenlendi */
                width: 100%;
                max-width: 150px; /* Mobil görünümde input max-width'ini koru */
                height: 30px; /* Mobil görünümde de sabit yükseklik */
            }

            .checkbox-group {
                flex-direction: row; /* Mobil görünümde de yan yana */
                justify-content: center;
                align-items: center;
            }

            .users-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Mobil için daha da küçültüldü */
                gap: 10px; /* Mobil için daha az boşluk */
            }

            .user {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 8px; /* Mobil için daha az padding */
            }

            .user img {
                margin-bottom: 5px;
                width: 50px; /* Mobil için daha küçük resim */
                height: 50px; /* Mobil için daha küçük resim */
            }

            .user-details {
                text-align: center;
            }

            .action-buttons {
                justify-content: center;
                gap: 4px; /* Mobil için daha az boşluk */
            }

            .action-buttons button {
                padding: 2px 5px; /* Mobil için daha az padding */
                font-size: 0.65rem; /* Mobil için daha küçük font */
            }

            #goToTopBtn {
                bottom: 20px;
                right: 20px;
                padding: 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Gartic.io Canlı Kullanıcı Listesi</h1>

    <div class="language-selection">
        <h3>Dil Seçimi</h3>
        <select id="languageSelect" class="form-select">
        </select>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" onkeyup="searchUsers()" placeholder="Kullanıcı adı ara...">
        <input type="number" id="proxyCountInput" min="0" value="0" placeholder="Proxy sayısı">
        <button onclick="startProxyProcess()" id="startProxiesButton" style="width: auto; padding: 5px 10px;"><i class="fas fa-play"></i> Proxy'leri Başlat</button>
        <button onclick="resetFiltersAndLoadUsers()" id="refreshButton"><i class="fas fa-sync-alt"></i> Yenile</button>
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="havefotoCheckbox" onchange="filterUsers()"> Fotoğraflı
            </label>
            <label>
                <input type="checkbox" id="nofotoCheckbox" onchange="filterUsers()"> Fotosuz
            </label>
            <label>
                <input type="checkbox" id="discordCheckbox" onchange="filterUsers()"> Discord
            </label>
        </div>
    </div>

    <div class="stats">
        <span id="playerCount">Listelenen kişi sayısı: 0</span> | <span id="totalPlayerCount">Toplam bulunan kişi sayısı: 0</span>
    </div>

    <div id="loadingIndicator">Kullanıcılar yükleniyor... Lütfen bekleyin.</div>

    <div id="usersContainer" class="users-grid">
    </div>

    <div id="proxyStatusContainer" style="margin-top: 20px; width: 100%; text-align: center; color: var(--text-color);">
        <h3>Proxy Durumu</h3>
        <div id="proxyListDisplay" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
            </div>
    </div>
</div>

<div id="profileContainer" class="profile-modal-overlay" style="display: none;">
    <div class="profile-modal-content">
        <h2 id="profileTitle"></h2>
        <img id="profileImage" src="" alt="Profil Fotoğrafı">
        <p id="profileName"></p>
        <div class="modal-buttons">
            <a id="viewPhotoLink" href="#" target="_blank" rel="noopener noreferrer" class="view-photo-link">
                <i class="fas fa-expand-alt"></i> Fotoğrafı Görüntüle
            </a>
            <button id="discordProfileBtn" class="discord-profile-btn" style="display: none;">
                <i class="fab fa-discord"></i> Discord Profili
            </button>
            <button class="close-btn" onclick="closeProfile()">Kapat</button>
        </div>
    </div>
</div>

<button onclick="goToTop()" id="goToTopBtn" title="Sayfa Başına Git"><i class="fas fa-arrow-up"></i></button>

<div class="footer">
    Mark tarafından yapılmıştır.
</div>

<script>
    const f = (selector) => document.querySelector(selector);
    const fa = (selector) => document.querySelectorAll(selector);

    let totalPlayerCount = 0;
    let favoriteUsers = JSON.parse(localStorage.getItem('favoriteUsers')) || [];
    let isProcessingRooms = false;
    const ROOM_PROCESS_DELAY_MS = 1700;
    const WS_TIMEOUT_MS = 5000;
    let allUsersData = [];
    let abortController = null; // Mevcut istekleri iptal etmek için AbortController
    const languageFlags = { // Mevcut Temalar
        23: { name: 'Azərbaycanca', flag: '🇦🇿' },
        45: { name: 'Bahasa Indonesia', flag: '🇮🇩' },
        11: { name: 'Čeština', flag: '🇨🇿' },
        14: { name: 'Deutsch', flag: '🇩🇪' },
        2: { name: 'English', flag: '🇬🇧' }, // UK's flag for general English, can be 🇺🇸 for US
        3: { name: 'Español', flag: '🇪🇸' },
        4: { name: 'Français', flag: '🇫🇷' },
        6: { name: 'Italiano', flag: '🇮🇹' },
        44: { name: 'Magyar', flag: '🇭🇺' },
        18: { name: 'Nederlands', flag: '🇳🇱' },
        10: { name: 'Polski', flag: '🇵🇱' },
        1: { name: 'Português', flag: '🇵🇹' },
        58: { name: 'Română', flag: '🇷🇴' },
        22: { name: 'Slovenčina', flag: '🇸🇰' },
        13: { name: 'Tiếng Việt', flag: '🇻🇳' },
        8: { name: 'Türkçe', flag: '🇹🇷' },
        21: { name: 'български език', flag: '🇧🇬' },
        7: { name: 'Русский', flag: '🇷🇺' },
        40: { name: 'עברית', flag: '🇮🇱' }, // Hebrew
        19: { name: 'العربية', flag: '🇸🇦' }, // Saudi Arabia for Arabic, can be general 🇦🇪 or other
        34: { name: 'فارسی', flag: '🇮🇷' }, // Persian
        12: { name: 'ภาษาไทย', flag: '🇹🇭' },
        16: { name: '中文 (简化字)', flag: '🇨🇳' },
        9: { name: '中文 (臺灣)', flag: '🇹🇼' },
        17: { name: '中文 (香港)', flag: '🇭🇰' },
        15: { name: '日本語', flag: '🇯🇵' },
        20: { name: '한국어', flag: '🇰🇷' },
        // Mevcut Olmayan Temalar (Eğer kullanılırsa) - Sadece örnekler, tümünü eklemek zorunda değilsiniz
        26: { name: 'Afrikaans', flag: '🇿🇦' },
        55: { name: 'Bahasa Melayu', flag: '🇲🇾' },
        30: { name: 'Català', flag: '🇪🇸' },
        31: { name: 'Dansk', flag: '🇩🇰' },
        33: { name: 'Eesti', flag: '🇪🇪' },
        67: { name: 'Esperanto', flag: '🏳️' },
        36: { name: 'Føroyskt', flag: '🇫🇴' },
        37: { name: 'Gaeilge', flag: '🇮🇪' },
        38: { name: 'Galego', flag: '🇪🇸' },
        43: { name: 'Hrvatski', flag: '🇭🇷' },
        46: { name: 'Íslenska', flag: '🇮🇸' },
        66: { name: 'Kurdî', flag: '🇮🇶' },
        52: { name: 'Latviešu', flag: '🇱🇻' },
        50: { name: 'Lëtzebuergesch', flag: '🇱🇺' },
        68: { name: 'Lietuvių', flag: '🇱🇹' },
        56: { name: 'Malti', flag: '🇲🇹' },
        53: { name: 'Mакедонски', flag: '🇲🇰' },
        65: { name: 'Norsk', flag: '🇳🇴' },
        61: { name: 'Shqip', flag: '🇦🇱' },
        59: { name: 'Slovenščina', flag: '🇸🇮' },
        35: { name: 'Suomi', flag: '🇫🇮' },
        24: { name: 'Svenska', flag: '🇸🇪' },
        62: { name: '...

    };

    const roomSC = 2; // Default Gartic.io room code.
    let currentLanguage = 8; // Default to Turkish (8)

    // Yeni proxy listesi
    const proxylist=[{"id":"43","ip":"108.181.21.229"},{"id":"44","ip":"108.181.33.135"},{"id":"45","ip":"108.181.33.117"},{"id":"46","ip":"108.181.33.119"},{"id":"47","ip":"108.181.34.57"},{"id":"48","ip":"108.181.34.71"},{"id":"49","ip":"108.181.30.85"},{"id":"50","ip":"108.181.34.149"},{"id":"51","ip":"108.181.32.49"},{"id":"52","ip":"108.181.32.73"},{"id":"53","ip":"108.181.32.55"},{"id":"54","id":"108.181.32.61"},{"id":"56","ip":"108.181.32.59"},{"id":"63","ip":"108.181.43.67"},{"id":"64","ip":"108.181.34.45"},{"id":"68","ip":"108.181.24.243"},{"id":"69","ip":"108.181.34.177"},{"id":"92","ip":"108.181.34.157"},{"id":"144","ip":"195.3.223.166"},{"id":"145","ip":"195.3.223.164"},{"id":"146","ip":"146.19.24.89"},{"id":"149","ip":"195.3.222.15"},{"id":"150","ip":"185.16.39.161"},{"id":"154","ip":"95.214.53.145"},{"id":"157","ip":"95.214.53.152"},{"id":"161","ip":"108.181.8.179"},{"id":"162","ip":"108.181.9.39"},{"id":"163","ip":"108.181.11.39"},{"id":"164","ip":"108.181.6.89"},{"id":"172","ip":"208.87.240.203"},{"id":"173","ip":"208.87.240.219"},{"id":"174","ip":"208.87.240.251"},{"id":"176","ip":"208.87.241.149"},{"id":"177","ip":"108.181.4.237"},{"id":"175","ip":"108.181.4.237"},{"id":"178","ip":"208.87.241.209"},{"id":"179","ip":"108.181.4.241"},{"id":"181","ip":"208.87.240.35"},{"id":"182","ip":"108.181.5.29"},{"id":"180","ip":"208.87.242.233"},{"id":"183","ip":"208.87.242.233"},{"id":"184","ip":"208.87.240.67"},{"id":"185","ip":"95.214.53.48"},{"id":"186","ip":"195.3.222.40"},{"id":"187","ip":"185.225.191.49"},{"id":"189","ip":"185.225.191.57"},{"id":"198","ip":"108.181.11.173"},{"id":"199","ip":"108.181.11.193"},{"id":"200","ip":"108.181.11.137"},{"id":"201","ip":"108.181.11.171"},{"id":"202","ip":"108.181.11.175"},{"id":"203","ip":"185.16.39.144"},{"id":"204","ip":"185.16.39.213"},{"id":"205","ip":"178.211.139.238"},{"id":"216","ip":"185.246.84.18"},{"id":"219","ip":"185.246.84.66"}];

    // Yeni Global Değişkenler
    let activeProxyConnections = []; // [{ id, ip, status: 'initializing'|'loading'|'ready'|'error', websocket: null, users: [] }]
    let proxyProcessingQueue = [];
    let processingProxyCount = 0;
    let maxProxiesToOpen = 0;
    let csrfToken = ''; // CroxyProxy CSRF token. Bu tokenin sayfadan doğru şekilde alınması önemlidir.
                        // Eğer bu HTML doğrudan CroxyProxy.com üzerinden yüklenmiyorsa,
                        // bu değeri elle alıp buraya yapıştırmanız gerekebilir.

    // Sayfa yüklendiğinde dil seçeneklerini doldur
    document.addEventListener('DOMContentLoaded', () => {
        populateLanguageSelect();
        // Check if there's a stored language preference
        const storedLanguage = localStorage.getItem('selectedLanguage');
        if (storedLanguage) {
            currentLanguage = parseInt(storedLanguage);
            f('#languageSelect').value = currentLanguage;
        } else {
            // If no stored language, try to detect browser language
            const browserLang = navigator.language.split('-')[0];
            const langCodeMap = {
                'en': 2, 'es': 3, 'fr': 4, 'it': 6, 'pt': 1, 'ru': 7, 'tr': 8,
                'az': 23, 'id': 45, 'cs': 11, 'de': 14, 'hu': 44, 'nl': 18,
                'pl': 10, 'ro': 58, 'sk': 22, 'vi': 13, 'bg': 21, 'he': 40,
                'ar': 19, 'fa': 34, 'th': 12, 'zh': 16, 'tw': 9, 'hk': 17,
                'ja': 15, 'ko': 20
            };
            if (langCodeMap[browserLang]) {
                currentLanguage = langCodeMap[browserLang];
                f('#languageSelect').value = currentLanguage;
            }
        }
        
        // Try to get CSRF token from a hidden input if available on the current page.
        // This is primarily for if the HTML is run within a CroxyProxy context.
        const csrfInput = document.querySelector("input[name=csrf]");
        if (csrfInput) {
            csrfToken = csrfInput.value;
            console.log("CSRF Token obtained:", csrfToken);
        } else {
            console.warn("CSRF token input not found. Proxy loading might fail without it. Please ensure CSRF token is correctly set if running outside CroxyProxy.com environment.");
        }
    });

    function populateLanguageSelect() {
        const select = f('#languageSelect');
        for (const id in languageFlags) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = `${languageFlags[id].flag} ${languageFlags[id].name}`;
            select.appendChild(option);
        }
        select.onchange = (event) => {
            currentLanguage = parseInt(event.target.value);
            localStorage.setItem('selectedLanguage', currentLanguage);
            // Tüm aktif proxy bağlantılarını bu dilde yeniden başlat
            activeProxyConnections.forEach(conn => {
                if (conn.websocket) {
                    conn.websocket.close(); // Mevcut bağlantıyı kapat
                }
                connectToProxyAndFetchUsers(conn, currentLanguage); // Yeni dilde tekrar başlat
            });
        };
    }

    function searchUsers() {
        filterUsers();
    }

    function filterUsers() {
        const searchText = f("#searchInput").value.toLowerCase();
        const haveFoto = f("#havefotoCheckbox").checked;
        const noFoto = f("#nofotoCheckbox").checked;
        const discordOnly = f("#discordCheckbox").checked;

        let filteredUsers = allUsersData.filter(user => {
            const matchesSearch = user.name.toLowerCase().includes(searchText);
            const hasPhoto = user.profilePhotoUrl && user.profilePhotoUrl !== "https://gartic.io/images/avatar.png";
            const hasDiscord = user.discordUsername || user.discordId;

            const matchesFotoFilter = (haveFoto && hasPhoto) || (noFoto && !hasPhoto) || (!haveFoto && !noFoto);
            const matchesDiscordFilter = (discordOnly && hasDiscord) || (!discordOnly);

            return matchesSearch && matchesFotoFilter && matchesDiscordFilter;
        });

        renderUsers(filteredUsers);
    }

    function renderUsers(usersToRender) {
        const usersContainer = f("#usersContainer");
        usersContainer.innerHTML = '';
        usersToRender.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = `user ${!user.profilePhotoUrl || user.profilePhotoUrl === "https://gartic.io/images/avatar.png" ? 'nofoto' : ''} ${user.discordUsername ? 'discord' : ''}`;
            
            const profileImageUrl = user.profilePhotoUrl || 'https://gartic.io/images/avatar.png';
            
            userDiv.innerHTML = `
                <button class="favorite-btn ${favoriteUsers.includes(user.id) ? 'favorited' : ''}" onclick="toggleFavorite('${user.id}')">
                    <i class="fas fa-star"></i>
                </button>
                <img src="${profileImageUrl}" alt="${user.name}'s Profile Photo" onerror="this.onerror=null;this.src='https://gartic.io/images/avatar.png';" onclick="openProfileModal('${user.name}', '${profileImageUrl}', '${user.discordUsername || ''}', '${user.discordId || ''}')">
                <div class="user-details">
                    <b>${user.name}</b>
                    <i>${user.level ? `Lv${user.level}` : 'Lv1'}</i>
                    ${user.roomLink ? `<a href="${user.roomLink}" target="_blank" class="room-link" rel="noopener noreferrer">${user.roomLink.split('?')[0].replace('https://gartic.io/', '')}</a>` : ''}
                </div>
                <div class="action-buttons">
                    <button onclick="copyToClipboard('${user.name}')"><i class="fas fa-copy"></i> Kopyala</button>
                    ${user.discordUsername ? `<button class="discord-profile-btn" onclick="openProfileModal('${user.name}', '${profileImageUrl}', '${user.discordUsername}', '${user.discordId || ''}')"><i class="fab fa-discord"></i> Discord</button>` : ''}
                </div>
            `;
            usersContainer.appendChild(userDiv);
        });
        f("#playerCount").textContent = `Listelenen kişi sayısı: ${usersToRender.length}`;
        f("#totalPlayerCount").textContent = `Toplam bulunan kişi sayısı: ${allUsersData.length}`;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert("Kullanıcı adı kopyalandı: " + text);
        }).catch(err => {
            console.error("Kopyalama başarısız:", err);
            alert("Kullanıcı adı kopyalanamadı.");
        });
    }

    function openProfileModal(name, imageUrl, discordUsername, discordId) {
        f("#profileTitle").textContent = name;
        f("#profileImage").src = imageUrl;
        f("#profileImage").onerror = function() { this.onerror=null; this.src='https://gartic.io/images/avatar.png'; };
        f("#profileName").textContent = `Kullanıcı Adı: ${name}`;

        const viewPhotoLink = f("#viewPhotoLink");
        if (imageUrl && imageUrl !== 'https://gartic.io/images/avatar.png') {
            viewPhotoLink.href = imageUrl;
            viewPhotoLink.style.display = 'inline-flex';
        } else {
            viewPhotoLink.style.display = 'none';
        }

        const discordProfileBtn = f("#discordProfileBtn");
        if (discordUsername) {
            discordProfileBtn.style.display = 'inline-flex';
            discordProfileBtn.onclick = () => {
                let discordUrl = `https://discord.com/users/${discordId}`;
                if (discordId) {
                    // Try to open discord app, then fallback to web
                    window.open(`discord://-/users/${discordId}`, '_blank');
                    setTimeout(() => {
                        window.open(discordUrl, '_blank');
                    }, 500); // Small delay before opening web version as fallback
                } else {
                    alert(`Discord Kullanıcı Adı: ${discordUsername}\nID bulunamadı.`);
                }
            };
        } else {
            discordProfileBtn.style.display = 'none';
        }

        f("#profileContainer").style.display = 'flex';
    }

    function closeProfile() {
        f("#profileContainer").style.display = 'none';
    }

    // --- Yeni Proxy Yönetimi ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startProxyProcess() {
        if (isProcessingRooms) {
            alert("Zaten bir proxy işlemi devam ediyor. Lütfen bekleyin veya yenile butonuna basarak iptal edin.");
            return;
        }

        maxProxiesToOpen = parseInt(f("#proxyCountInput").value);
        if (isNaN(maxProxiesToOpen) || maxProxiesToOpen <= 0) {
            alert("Lütfen açmak istediğiniz proxy sayısını girin (minimum 1).");
            return;
        }

        // Önceki tüm bağlantıları ve iframe'leri temizle
        activeProxyConnections.forEach(conn => {
            if (conn.websocket) {
                conn.websocket.close();
            }
            if (conn.iframe) {
                conn.iframe.remove();
            }
        });
        activeProxyConnections = [];
        allUsersData = [];
        f("#usersContainer").innerHTML = ''; // Kullanıcı listesini temizle
        f("#proxyListDisplay").innerHTML = ''; // Proxy durumu ekranını temizle

        proxyProcessingQueue = shuffleArray([...proxylist]).slice(0, maxProxiesToOpen);
        processingProxyCount = 0;
        isProcessingRooms = true;
        f("#loadingIndicator").style.display = 'block';
        f("#refreshButton").disabled = true; // Yenile butonunu devre dışı bırak
        f("#startProxiesButton").disabled = true; // Başlat butonunu devre dışı bırak

        console.log(`Toplam ${maxProxiesToOpen} proxy işlenecek.`);
        processNextProxy();
    }

    function processNextProxy() {
        if (proxyProcessingQueue.length > 0) {
            const proxyItem = proxyProcessingQueue.shift(); // Kuyruktan ilkini al
            processingProxyCount++;
            console.log(`Proxy (${proxyItem.ip}) yükleniyor... Kalan: ${proxyProcessingQueue.length}`);
            
            const proxyConnObject = {
                id: proxyItem.id,
                ip: proxyItem.ip,
                status: 'Yükleniyor...',
                websocket: null,
                users: [],
                iframe: null, // iframe referansını sakla
                statusDiv: null // Durum div'i referansını sakla
            };
            activeProxyConnections.push(proxyConnObject);
            updateProxyStatusDisplay(proxyConnObject);

            createHiddenIframe(proxyConnObject);
        } else {
            console.log("Tüm proxyler işlendi veya kuyruk boş.");
            if (activeProxyConnections.every(conn => conn.status !== 'Yükleniyor...')) {
                 // Sadece tüm proxy'lerin yüklenmesi bittiğinde gizle
                f("#loadingIndicator").style.display = 'none';
                f("#refreshButton").disabled = false;
                f("#startProxiesButton").disabled = false;
                isProcessingRooms = false;
            }
        }
    }

    function createHiddenIframe(proxyConnObject) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none'; // Gizli tut
        iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-same-origin'); // Güvenlik için sandbox
        // CSRF token'ı `csrfToken` değişkeninden alınır. Eğer `csrfToken` boşsa, bu değer boş gönderilir.
        iframe.src = `https://www.croxyproxy.com/requests?fso=&url=gartic.io&proxyServerId=${proxyConnObject.id}&csrf=${csrfToken}&demo=0&frontOrigin=https://www.croxyproxy.com`;
        
        iframe.onload = () => {
            console.log(`Proxy Iframe yüklendi: ${proxyConnObject.ip}`);
            proxyConnObject.status = 'Bağlanıyor...';
            updateProxyStatusDisplay(proxyConnObject);
            // Iframe yüklendikten sonra belirli bir gecikme ekleyebiliriz
            setTimeout(() => {
                connectToProxyAndFetchUsers(proxyConnObject, currentLanguage);
            }, ROOM_PROCESS_DELAY_MS); // Gartic'in yüklenmesi için biraz bekle
        };

        iframe.onerror = () => {
            console.error(`Proxy Iframe hatası: ${proxyConnObject.ip}`);
            proxyConnObject.status = 'Hata';
            updateProxyStatusDisplay(proxyConnObject);
            processNextProxy(); // Hatalı proxiden sonra bir sonrakini dene
        };

        proxyConnObject.iframe = iframe;
        document.body.appendChild(iframe); // Veya belirli bir hidden div'e ekleyin
    }

    function updateProxyStatusDisplay(proxyConnObject) {
        let statusDiv = proxyConnObject.statusDiv;
        if (!statusDiv) {
            statusDiv = document.createElement('span');
            statusDiv.className = 'proxy-status-item';
            statusDiv.style.display = 'inline-block';
            statusDiv.style.padding = '5px 10px';
            statusDiv.style.margin = '5px';
            statusDiv.style.borderRadius = '5px';
            statusDiv.style.fontSize = '0.9rem';
            statusDiv.style.fontWeight = 'bold';
            document.getElementById('proxyListDisplay').appendChild(statusDiv);
            proxyConnObject.statusDiv = statusDiv;
        }

        let color = 'gray'; // Default initializing
        if (proxyConnObject.status === 'Yükleniyor...') {
            color = 'orange';
        } else if (proxyConnObject.status === 'Bağlanıyor...') {
            color = 'lightgray';
        } else if (proxyConnObject.status.includes('Aktif')) {
            color = 'green';
        } else if (proxyConnObject.status.includes('Hata')) {
            color = 'red';
        } else if (proxyConnObject.status.includes('Kapalı')) {
            color = 'darkred';
        } else if (proxyConnObject.status.includes('Zaman Aşımı')) {
            color = 'purple';
        }
        statusDiv.style.backgroundColor = color;
        statusDiv.style.color = 'white';
        statusDiv.textContent = `${proxyConnObject.ip} [${proxyConnObject.status}]`;
    }

    function connectToProxyAndFetchUsers(proxyConnObject, languageId) {
        const originalWsUrl = `wss://${roomSC}.gartic.io/socket.io/?EIO=3&transport=websocket`;
        // 'o' parametresi için Base64 kodlu "https://gartic.io" değeri kullanılıyor.
        const croxyproxyWsUrl = `wss://${proxyConnObject.ip}/__cpw.php?u=${originalWsUrl}&o=aHR0cHM6Ly9nYXJ0aWMuaW8=`;

        console.log(`Connecting to WebSocket via proxy ${proxyConnObject.ip}: ${croxyproxyWsUrl}`);

        if (proxyConnObject.websocket) {
            proxyConnObject.websocket.close(); // Eski bağlantıyı kapat
        }

        const ws = new WebSocket(croxyproxyWsUrl);
        proxyConnObject.websocket = ws;

        let wsTimeout = setTimeout(() => {
            if (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN) {
                console.warn(`WebSocket zaman aşımı: ${proxyConnObject.ip}`);
                ws.close(); // Bağlantıyı kapat
                proxyConnObject.status = 'Zaman Aşımı';
                updateProxyStatusDisplay(proxyConnObject);
                processNextProxy(); // Sonraki proxy'yi dene (eğer henüz tamamlanmadıysa)
            }
        }, WS_TIMEOUT_MS);

        ws.onopen = () => {
            clearTimeout(wsTimeout);
            console.log(`WebSocket bağlantısı açıldı: ${proxyConnObject.ip}`);
            proxyConnObject.status = 'Aktif';
            updateProxyStatusDisplay(proxyConnObject);
            // Gartic.io'ya dil ve oda bilgisini gönder
            ws.send(`42["loadRoom", ${languageId}]`);
            // WebSocket üzerinden kullanıcıları çekmek için ek mesajlar gönderebilirsiniz
            // Gartic.io'nun tam WebSocket protokolünü bilmediğimizden, bu kısım varsayımsaldır.
            // Genellikle 42 ile başlayan mesajlar "event" mesajlarıdır.
            // Buraya kullanıcı listesini tetikleyecek spesifik mesaj gelmeli.
        };

        ws.onmessage = (event) => {
            const message = event.data;
            if (typeof message === 'string' && message.startsWith('42')) {
                try {
                    const data = JSON.parse(message.substring(2));
                    const eventName = data[0];
                    const payload = data[1];

                    if (eventName === 'roomUsers') {
                        if (Array.isArray(payload)) {
                            // Sadece yeni kullanıcıları ekle, mevcutları güncelle
                            payload.forEach(newUser => {
                                const existingUserIndex = proxyConnObject.users.findIndex(u => u.id === newUser.id);
                                if (existingUserIndex > -1) {
                                    // Kullanıcı mevcut, güncelle
                                    proxyConnObject.users[existingUserIndex] = newUser;
                                } else {
                                    // Yeni kullanıcı, ekle
                                    proxyConnObject.users.push(newUser);
                                }
                            });
                        }
                        // Tüm proxy bağlantılarından gelen veriyi birleştir ve render et
                        combineAndRenderAllUsers();
                    } else if (eventName === 'roomUserEnter') {
                        const newUser = payload;
                        if (!proxyConnObject.users.some(u => u.id === newUser.id)) {
                            proxyConnObject.users.push(newUser);
                            combineAndRenderAllUsers();
                        }
                    } else if (eventName === 'roomUserLeave') {
                        proxyConnObject.users = proxyConnObject.users.filter(user => user.id !== payload.id);
                        combineAndRenderAllUsers();
                    }
                    // Diğer Gartic.io WebSocket olaylarını burada işleyebilirsiniz
                } catch (e) {
                    // console.error("Mesaj parse hatası veya bilinmeyen format:", e, message);
                }
            }
        };

        ws.onerror = (error) => {
            clearTimeout(wsTimeout);
            console.error(`WebSocket hatası (${proxyConnObject.ip}):`, error);
            proxyConnObject.status = 'Hata';
            updateProxyStatusDisplay(proxyConnObject);
            processNextProxy(); // Hatalı proxiden sonra bir sonrakini dene
        };

        ws.onclose = () => {
            clearTimeout(wsTimeout);
            console.log(`WebSocket bağlantısı kapatıldı: ${proxyConnObject.ip}`);
            if (proxyConnObject.status !== 'Hata' && proxyConnObject.status !== 'Zaman Aşımı') {
                proxyConnObject.status = 'Kapalı';
                updateProxyStatusDisplay(proxyConnObject);
            }
            // Bağlantı kapandığında kullanıcı listesini güncelle
            combineAndRenderAllUsers();
        };
    }

    function combineAndRenderAllUsers() {
        // Tüm aktif proxy bağlantılarından gelen kullanıcıları birleştir
        let combinedUsers = new Map();
        activeProxyConnections.forEach(conn => {
            conn.users.forEach(user => {
                combinedUsers.set(user.id, user); // ID'ye göre benzersiz kullanıcılar
            });
        });
        allUsersData = Array.from(combinedUsers.values());
        sortAndRenderUsers();
    }

    function sortAndRenderUsers() {
        // Favorileri en üste, sonra alfabetik sıralama
        const sortedUsers = [...allUsersData].sort((a, b) => {
            const aIsFavorite = favoriteUsers.includes(a.id);
            const bIsFavorite = favoriteUsers.includes(b.id);

            if (aIsFavorite && !bIsFavorite) return -1;
            if (!aIsFavorite && bIsFavorite) return 1;

            return a.name.localeCompare(b.name);
        });
        renderUsers(sortedUsers);
    }

    // Refresh button functionality modified to stop all proxy processes
    f('#refreshButton').addEventListener('click', () => {
        activeProxyConnections.forEach(conn => {
            if (conn.websocket) {
                conn.websocket.close(); // Tüm WebSocket bağlantılarını kapat
            }
            if (conn.iframe) {
                conn.iframe.remove(); // Tüm iframe'leri kaldır
            }
        });
        activeProxyConnections = [];
        allUsersData = [];
        f("#usersContainer").innerHTML = '';
        f("#proxyListDisplay").innerHTML = '';
        isProcessingRooms = false;
        f("#loadingIndicator").style.display = 'none';
        f("#refreshButton").disabled = false;
        f("#startProxiesButton").disabled = false;
        f("#playerCount").textContent = `Listelenen kişi sayısı: 0`;
        f("#totalPlayerCount").textContent = `Toplam bulunan kişi sayısı: 0`;
        console.log("Tüm proxy işlemleri iptal edildi ve bağlantılar kapatıldı.");
    });


    function resetFiltersAndLoadUsers() {
        f("#searchInput").value = "";
        f("#havefotoCheckbox").checked = false;
        f("#nofotoCheckbox").checked = false;
        f("#discordCheckbox").checked = false;
        filterUsers();
    }

    function toggleFavorite(userId) {
        if (favoriteUsers.includes(userId)) {
            favoriteUsers = favoriteUsers.filter(id => id !== userId);
        } else {
            favoriteUsers.push(userId);
        }
        localStorage.setItem('favoriteUsers', JSON.stringify(favoriteUsers));
        sortAndRenderUsers();
    }

    // Go to Top functionality
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
        const goToTopBtn = f("#goToTopBtn");
        if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
            goToTopBtn.style.display = "block";
        } else {
            goToTopBtn.style.display = "none";
        }
    }

    function goToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>
